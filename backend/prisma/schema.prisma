// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Estado {
  por_hacer   @map("por-hacer")
  en_progreso @map("en-progreso")
  completado
}

enum Prioridad {
  alta
  media
  baja
}

model Proyecto {
  id          String       @id @default(cuid())
  nombre      String
  descripcion String?
  color       String       @default("#3B82F6")
  deadline    DateTime?
  creadoPor   String
  usuarios    String[]     @db.Text
  tareas      Tarea[]
  mensajes    ChatMessage[]

  // ðŸ‘‡ NUEVO: relaciÃ³n con el registro de auditorÃ­a (logs)
  logs        AuditLog[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Tarea {
  id          String    @id @default(uuid())
  proyecto    Proyecto  @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId  String

  titulo      String
  descripcion String?
  prioridad   Prioridad @default(media)
  deadline    DateTime?
  etiquetas   String[]  @db.Text
  estado      Estado    @default(por_hacer)

  // ðŸ‘‡ NUEVO: trazabilidad de autorÃ­a y Ãºltima ediciÃ³n
  createdBy   String?
  updatedBy   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChatMessage {
  id          String    @id @default(cuid())
  proyecto    Proyecto  @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId  String
  sender      String
  text        String    @db.Text
  ts          DateTime  @default(now())

  @@index([proyectoId, ts])
}

model AuditLog {
  id          String    @id @default(cuid())
  proyecto    Proyecto  @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId  String

  // entidad afectada (libre para no romper nada en el BE)
  entity      String          // "proyecto" | "tarea" | "chat" | ...
  entityId    String?
  action      String          // "create" | "update" | "delete" | "move" | ...
  actorEmail  String
  payload     Json?

  createdAt   DateTime  @default(now())

  @@index([proyectoId, createdAt])
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String

  name       String?
  avatarUrl  String?
  birthdate  DateTime?
  jobTitle   String?
  phone      String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}
